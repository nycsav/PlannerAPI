# Cloud Scheduler Verification Guide

## Overview

Daily Intelligence cards are generated by the `generateDiscoverCards` Cloud Function, which should be triggered automatically by Cloud Scheduler at **6:00 AM ET** every day.

**Current Status**: You need to verify if this is set up correctly.

---

## Prerequisites

Before running these commands, ensure you have:

1. **Google Cloud SDK installed:**
   ```bash
   gcloud --version
   ```
   If not installed: https://cloud.google.com/sdk/docs/install

2. **Authenticated to Google Cloud:**
   ```bash
   gcloud auth login
   gcloud config set project plannerapi-prod
   ```

3. **Firebase CLI installed:**
   ```bash
   firebase --version
   ```
   If not installed: `npm install -g firebase-tools`

---

## Step 1: Enable Cloud Scheduler API

```bash
# Enable the Cloud Scheduler API
gcloud services enable cloudscheduler.googleapis.com \
  --project=plannerapi-prod
```

Expected output:
```
Enabling service [cloudscheduler.googleapis.com] on project [plannerapi-prod]...
```

---

## Step 2: Check if Scheduler Job Exists

```bash
# List all Cloud Scheduler jobs
gcloud scheduler jobs list \
  --location=us-central1 \
  --project=plannerapi-prod
```

### Expected Output (if job exists):
```
ID                      LOCATION     SCHEDULE         TIMEZONE         NEXT_RUN
generateDiscoverCards   us-central1  0 6 * * *        America/New_York 2024-01-23 06:00:00+00:00
```

### If No Jobs Are Listed:
The scheduler job doesn't exist and needs to be created. Go to **Step 3**.

---

## Step 3: Create Scheduler Job (If Needed)

If the job doesn't exist, create it:

```bash
# Create the Cloud Scheduler job
gcloud scheduler jobs create http generateDiscoverCards \
  --schedule="0 6 * * *" \
  --time-zone="America/New_York" \
  --uri="https://us-central1-plannerapi-prod.cloudfunctions.net/generateDiscoverCards" \
  --http-method=POST \
  --location=us-central1 \
  --project=plannerapi-prod
```

### Expected Output:
```
Created job [generateDiscoverCards].
```

### If Job Already Exists:
You'll see:
```
ERROR: (gcloud.scheduler.jobs.create) Error 409: Job already exists.
```

This is fine - the job is already configured.

---

## Step 4: Manual Test (Run Job Now)

Test that the function works correctly by triggering it manually:

```bash
# Manually run the scheduler job
gcloud scheduler jobs run generateDiscoverCards \
  --location=us-central1 \
  --project=plannerapi-prod
```

### Expected Output:
```
Scheduling job [generateDiscoverCards] in region [us-central1] to run now.
```

---

## Step 5: Verify Function Executed

Check the Cloud Function logs to see if it succeeded:

```bash
# View recent Cloud Function logs
firebase functions:log --only generateDiscoverCards --since 10m
```

### Expected Log Output:
```
i  functions: Beginning execution of "generateDiscoverCards"
✓ Generated 10 discover cards successfully
✓ All cards stored in Firestore (discover_cards collection)
✓ Cache hit: 8 cards (prompt caching working)
i  functions: Execution of "generateDiscoverCards" took 12345 ms, finished with status: 'ok'
```

### Troubleshooting Logs:

**If you see "Function not found":**
- Deploy the function: `cd functions && npm run deploy`
- Check the URL matches: `https://us-central1-plannerapi-prod.cloudfunctions.net/generateDiscoverCards`

**If you see "API key error":**
- Verify API keys are set in Firebase config:
  ```bash
  firebase functions:config:get
  ```
- Should show:
  ```
  {
    "pplx": {
      "api_key": "pplx-..."
    },
    "anthropic": {
      "api_key": "sk-ant-..."
    }
  }
  ```

**If you see "Timeout":**
- Function took > 600 seconds
- Check if Perplexity or Anthropic APIs are responding
- Test manually: `curl https://api.perplexity.ai/models -H "Authorization: Bearer $PPLX_API_KEY"`

---

## Step 6: Verify Cards in Firestore

Open Firebase Console and check if new cards were created:

```bash
# Open Firebase Console directly
echo "Open: https://console.firebase.google.com/u/0/project/plannerapi-prod/firestore/data/discover_cards"
```

**What to look for:**
- [ ] Collection `discover_cards` exists
- [ ] Has 10 recent documents (created today)
- [ ] Document IDs are timestamps
- [ ] Each document has fields:
  - `pillar`: `ai_strategy`, `brand_performance`, `competitive_intel`, or `media_trends`
  - `title`: Card title
  - `summary`: 2-3 sentence summary
  - `keySignals`: Array of key points
  - `publishedAt`: Today's date
  - `type`: `brief` or `hot_take`

---

## Step 7: Check Frontend Displays New Cards

1. Go to https://plannerapi-prod.web.app
2. Look for **Daily Intelligence** section
3. Should show 10 cards from today
4. Filter by pillar (All, AI Strategy, Brand Performance, etc.)
5. Click on a card to see full brief

---

## Step 8: Verify Schedule is Active

```bash
# Describe the scheduler job (see all details)
gcloud scheduler jobs describe generateDiscoverCards \
  --location=us-central1 \
  --project=plannerapi-prod
```

### Expected Output:
```
name: projects/plannerapi-prod/locations/us-central1/jobs/generateDiscoverCards
description: ''
schedule: 0 6 * * *
timezone: America/New_York
httpTarget:
  uri: https://us-central1-plannerapi-prod.cloudfunctions.net/generateDiscoverCards
  httpMethod: POST
state: ENABLED
userUpdateTime: '2024-01-15T14:32:21Z'
lastAttemptTime: '2024-01-22T11:00:15Z'
lastSuccessfulExecutionTime: '2024-01-22T11:00:15Z'
nextScheduledTime: '2024-01-23T11:00:00Z'
```

**Key things to verify:**
- [ ] `state: ENABLED` - Job is active
- [ ] `schedule: 0 6 * * *` - Runs at 6 AM ET daily
- [ ] `lastSuccessfulExecutionTime` - Recent (should be today)
- [ ] `nextScheduledTime` - Tomorrow at 6 AM

---

## Schedule Format Explanation

The cron expression `0 6 * * *` means:

```
┌───────────── minute (0 - 59)
│ ┌───────────── hour (0 - 23)
│ │ ┌───────────── day of month (1 - 31)
│ │ │ ┌───────────── month (1 - 12)
│ │ │ │ ┌───────────── day of week (0 - 6) (Sunday to Saturday)
│ │ │ │ │
│ │ │ │ │
0 6 * * *

= 6:00 AM every day
```

**Other useful schedules:**
- `0 */4 * * *` - Every 4 hours
- `*/15 * * * *` - Every 15 minutes
- `0 9,14,18 * * *` - At 9 AM, 2 PM, and 6 PM

---

## Troubleshooting

### Problem: Job doesn't exist
**Solution:**
```bash
gcloud scheduler jobs create http generateDiscoverCards \
  --schedule="0 6 * * *" \
  --time-zone="America/New_York" \
  --uri="https://us-central1-plannerapi-prod.cloudfunctions.net/generateDiscoverCards" \
  --http-method=POST \
  --location=us-central1 \
  --project=plannerapi-prod
```

### Problem: Job exists but is DISABLED
**Solution:**
```bash
gcloud scheduler jobs resume generateDiscoverCards \
  --location=us-central1 \
  --project=plannerapi-prod
```

### Problem: Manual trigger gives "403 Forbidden"
**Solution:** The Cloud Function needs public invocation permissions
```bash
gcloud functions add-iam-policy-binding generateDiscoverCards \
  --region=us-central1 \
  --member=serviceAccount:service-plannerapi-prod@gcp-sa-cloud-scheduler.iam.gserviceaccount.com \
  --role=roles/cloudfunctions.invoker \
  --project=plannerapi-prod
```

### Problem: Function times out (> 10 minutes)
**Solution:** Check API quotas
```bash
# Check Perplexity API status
curl https://api.perplexity.ai/models \
  -H "Authorization: Bearer $PPLX_API_KEY"

# Check if API keys are valid
firebase functions:config:get
```

### Problem: Cards not updating daily
**Options:**
1. Verify job is enabled: `gcloud scheduler jobs describe generateDiscoverCards --location=us-central1`
2. Check logs: `firebase functions:log --only generateDiscoverCards`
3. Manually trigger: `gcloud scheduler jobs run generateDiscoverCards --location=us-central1`

---

## Complete Verification Checklist

Run through this checklist to ensure Cloud Scheduler is working:

- [ ] Cloud Scheduler API is enabled
- [ ] Scheduler job "generateDiscoverCards" exists
- [ ] Job is in ENABLED state
- [ ] Schedule is `0 6 * * *` (6 AM ET daily)
- [ ] Last successful execution was recent
- [ ] Manual trigger completes without errors
- [ ] Cloud Function logs show success
- [ ] 10 new cards appear in Firestore `discover_cards`
- [ ] Cards have correct pillar distribution (3/3/2/2)
- [ ] Frontend displays new cards in Daily Intelligence section
- [ ] Filtering by pillar works correctly
- [ ] Card details display properly

---

## Monitoring & Alerts

To set up monitoring (optional):

```bash
# Create an alert for job failures
gcloud alpha monitoring policies create \
  --notification-channels=YOUR_CHANNEL_ID \
  --display-name="Cloud Scheduler Job Failure" \
  --condition-display-name="generateDiscoverCards failed" \
  --condition-threshold-value=1 \
  --condition-threshold-comparison=COMPARISON_GT
```

---

## Next Steps

1. **Run all verification steps above**
2. **Document the results**
3. **Report back with:**
   - Whether the job exists
   - Last execution time
   - Any errors in logs
   - Current card count in Firestore

Then we can move to **Phase 3: Testing**.
